@using UI.Features.Shared.Domain

<div class="space-y-6">
    @if (IsLoading)
    {
        @for (int i = 0; i < 3; i++)
        {
            <div class="bg-[#232a3b] rounded-lg shadow-lg overflow-hidden animate-pulse">
                <div class="bg-[#2c3549] p-4">
                    <div class="h-6 bg-gray-700 rounded w-1/4"></div>
                </div>
                <div class="p-4">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="text-left text-gray-400 border-b border-gray-700">
                            <tr>
                                <th class="pb-2 font-medium">#</th>
                                @if (!ShowCompactView)
                                {
                                    <th class="pb-2 font-medium">Cover</th>
                                }
                                <th class="pb-2 font-medium">Title</th>
                                <th class="pb-2 font-medium">Artist</th>
                                @if (!ShowCompactView)
                                {
                                    <th class="pb-2 font-medium">Album</th>
                                    <th class="pb-2 font-medium">Release Date</th>
                                    <th class="pb-2 font-medium text-right">Details</th>
                                }
                            </tr>
                            </thead>
                            <tbody>
                            @for (int j = 0; j < 5; j++)
                            {
                                <tr class="border-b border-gray-700/50">
                                    <td class="py-3 text-gray-400">@(j + 1)</td>
                                    @if (!ShowCompactView)
                                    {
                                        <td class="py-3">
                                            <div class="w-10 h-10 rounded bg-gray-700"></div>
                                        </td>
                                    }
                                    <td class="py-3">
                                        <div class="h-4 bg-gray-700 rounded w-3/4"></div>
                                    </td>
                                    <td class="py-3">
                                        <div class="h-4 bg-gray-700 rounded w-1/2"></div>
                                    </td>
                                    @if (!ShowCompactView)
                                    {
                                        <td class="py-3">
                                            <div class="h-4 bg-gray-700 rounded w-2/3"></div>
                                        </td>
                                        <td class="py-3">
                                            <div class="h-4 bg-gray-700 rounded w-20"></div>
                                        </td>
                                        <td class="py-3">
                                            <div class="h-12 bg-gray-700 rounded w-32 ml-auto"></div>
                                        </td>
                                    }
                                </tr>
                            }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        }
    }
    else
    {
        @foreach (string? key in GroupedTracks.Keys)
        {
            <div class="bg-[#232a3b] rounded-lg shadow-lg overflow-hidden">
                <div class="bg-[#2c3549] p-4">
                    <div class="flex justify-between items-center">
                        <h2 class="text-xl font-semibold text-white">
                            @key (@GroupedTracks[key].Count tracks)
                        </h2>
                        <button @onclick="() => ToggleSectionCollapse(key)"
                                class="text-gray-300 hover:text-white p-1 rounded-full hover:bg-gray-700/30 transition-colors">
                            @if (IsSectionCollapsed(key))
                            {
                                <svg class="w-5 h-5"
                                     fill="currentColor"
                                     viewBox="0 0 20 20"
                                     xmlns="http://www.w3.org/2000/svg">
                                    <path fill-rule="evenodd"
                                          d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z"
                                          clip-rule="evenodd"/>
                                </svg>
                            }
                            else
                            {
                                <svg class="w-5 h-5"
                                     fill="currentColor"
                                     viewBox="0 0 20 20"
                                     xmlns="http://www.w3.org/2000/svg">
                                    <path fill-rule="evenodd"
                                          d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
                                          clip-rule="evenodd"/>
                                </svg>
                            }
                        </button>
                    </div>
                </div>
                @if (!IsSectionCollapsed(key))
                {
                    <div class="p-4">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="text-left text-gray-400 border-b border-gray-700">
                                <tr>
                                    <th class="pb-2 font-medium">#</th>
                                    @if (!ShowCompactView)
                                    {
                                        <th class="pb-2 font-medium">Cover</th>
                                    }
                                    <th class="pb-2 font-medium">Title</th>
                                    <th class="pb-2 font-medium">Artist</th>
                                    @if (!ShowCompactView)
                                    {
                                        <th class="pb-2 font-medium">Album</th>
                                        <th class="pb-2 font-medium">Release Date</th>
                                        <th class="pb-2 font-medium text-right">Details</th>
                                    }
                                </tr>
                                </thead>
                                <tbody>
                                @{
                                    int trackNumber = 1;
                                }
                                @foreach (Track track in GroupedTracks[key])
                                {
                                    <tr class="hover:bg-gray-800/30 border-b border-gray-700/50">
                                        <td class="py-3 text-gray-400">@trackNumber</td>
                                        @if (!ShowCompactView)
                                        {
                                            <td class="py-3">
                                                @if (track.Album != null && !string.IsNullOrEmpty(track.Album.ImageUrl))
                                                {
                                                    <img src="@track.Album.ImageUrl"
                                                         alt="@track.Album.Name"
                                                         class="w-10 h-10 rounded"/>
                                                }
                                                else
                                                {
                                                    <div class="w-10 h-10 rounded bg-gray-700 flex items-center justify-center">
                                                        <svg class="w-6 h-6 text-gray-500"
                                                             fill="currentColor"
                                                             viewBox="0 0 20 20"
                                                             xmlns="http://www.w3.org/2000/svg">
                                                            <path d="M18 3a1 1 0 00-1.196-.98l-10 2A1 1 0 006 5v9.114A4.369 4.369 0 005 14c-1.657 0-3 .895-3 2s1.343 2 3 2 3-.895 3-2V7.82l8-1.6v5.894A4.37 4.37 0 0015 12c-1.657 0-3 .895-3 2s1.343 2 3 2 3-.895 3-2V3z"/>
                                                        </svg>
                                                    </div>
                                                }
                                            </td>
                                        }
                                        <td class="py-3 text-white font-medium">@track.Name</td>
                                        <td class="py-3 text-gray-400">@track.GetArtistDisplay()</td>
                                        @if (!ShowCompactView)
                                        {
                                            <td class="py-3 text-gray-400">@track.Album?.Name</td>
                                            <td class="py-3 text-gray-400">@track.Album?.ReleaseDate</td>
                                            <td class="py-3 text-right">
                                                <div class="flex flex-col items-end text-[10px] text-gray-400 leading-tight">
                                                    <div class="flex gap-2">
                                                        <span>Ene: @(track.Energy.ToString("P0"))</span>
                                                        <span>Val: @(track.Valence.ToString("P0"))</span>
                                                        <span>Dan: @(track.Danceability.ToString("P0"))</span>
                                                    </div>
                                                    <div class="flex gap-2">
                                                        <span>Aco: @(track.Acousticness.ToString("P0"))</span>
                                                        <span>Ins: @(track.Instrumentalness.ToString("P0"))</span>
                                                        <span>Spe: @(track.Speechiness.ToString("P0"))</span>
                                                    </div>
                                                    <div class="flex gap-2 font-medium text-gray-300">
                                                        <span>@track.Tempo.ToString("F0") BPM</span>
                                                        <span>@track.GetKeyDisplay() @track.GetModeDisplay()</span>
                                                        <span>@track.Loudness.ToString("F1") dB</span>
                                                    </div>
                                                </div>
                                            </td>
                                        }
                                    </tr>
                                    trackNumber++;
                                }
                                </tbody>
                            </table>
                        </div>
                    </div>
                }
            </div>
        }
    }
</div>

@code {
    private readonly HashSet<string> _collapsedSections = new();

    [Parameter]
    public bool IsLoading { get; set; }

    [Parameter]
    public bool ShowCompactView { get; set; }

    [Parameter]
    public Dictionary<string, List<Track>> GroupedTracks { get; set; } = new();

    private void ToggleSectionCollapse(string key)
    {
        if (!_collapsedSections.Add(key))
        {
            _collapsedSections.Remove(key);
        }
    }

    private bool IsSectionCollapsed(string key) => _collapsedSections.Contains(key);
}

