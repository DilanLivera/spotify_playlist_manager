@page "/playlist/{PlaylistId}"
@using UI.Features.Shared.Domain
@using UI.Features.PlaylistDetails.Components
@using UI.Infrastructure.Spotify
@inject SpotifyPlaylistService SpotifyPlaylistService
@inject SpotifyTrackService SpotifyTrackService
@inject SpotifyAuthSessionManager SpotifyAuthSessionManager
@inject NavigationManager NavigationManager
@implements IDisposable
@rendermode InteractiveServer

<PageTitle>Playlist Details</PageTitle>

<div class="p-1">
    <div class="max-w-7xl mx-auto">
        <div class="mb-6">
            <a href="/"
               class="text-gray-400 hover:text-gray-300 flex items-center">
                <svg class="w-5 h-5 mr-1"
                     fill="none"
                     stroke="currentColor"
                     viewBox="0 0 24 24"
                     xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M15 19l-7-7 7-7"/>
                </svg>
                Back to Playlists
            </a>
        </div>

        <PlaylistHeader Playlist="@_playlist" />

        <TrackSortingControls @ref="_sortingControls"
                              IsLoading="@_isLoading"
                              LoadedCount="@_tracks.Count"
                              TotalCount="@(_playlist?.TrackCount ?? 0)"
                              GroupCount="@_groupedTracks.Count"
                              OnSortingChanged="HandleSortingChanged"
                              OnViewChanged="HandleViewChanged" />

        <AiFilterSection IsLoading="@_isLoading"
                         TotalTrackCount="@_tracks.Count"
                         Tracks="@_tracks"
                         CancellationToken="@(_cancellationTokenSource?.Token ?? CancellationToken.None)" />

        <TrackGroupList IsLoading="@_isLoading"
                        ShowCompactView="@(_sortingControls?.IsCompactView ?? false)"
                        GroupedTracks="@_groupedTracks" />
    </div>
</div>

@code {

    [Parameter]
    public string PlaylistId { get; set; } = string.Empty;

    private readonly List<Track> _tracks = [];
    private Dictionary<string, List<Track>> _groupedTracks = [];
    private bool _isLoading = true;
    private int _offset = 0;
    private const int BatchSize = 100;
    private bool _loadingMore = false;
    private bool _hasMoreTracks = true;
    private Playlist? _playlist;
    private CancellationTokenSource? _cancellationTokenSource;
    private TrackSortingControls? _sortingControls;

    protected override void OnInitialized()
    {
        // using Activity? activity = ObservabilityExtensions.StartActivity(name: "OnInitialized");

        _groupedTracks = new Dictionary<string, List<Track>>();
        _cancellationTokenSource = new CancellationTokenSource();

        if (!SpotifyAuthSessionManager.IsAuthenticated())
        {
            NavigationManager.NavigateTo(uri: "/spotify-auth");
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        // using Activity? activity = ObservabilityExtensions.StartActivity(name: "OnAfterRender");

        if (!firstRender) return;

        try
        {
            _playlist = await SpotifyPlaylistService.GetPlaylistAsync(PlaylistId);

            while (_hasMoreTracks && !_cancellationTokenSource!.Token.IsCancellationRequested)
            {
                await FetchMoreTracksAsync();
            }

            _isLoading = false;
            StateHasChanged();
        }
        catch (OperationCanceledException)
        {
            // Track loading was cancelled, this is expected when navigating away
        }
        catch (Exception)
        {
            _isLoading = false;
            StateHasChanged();

            throw;
        }
    }

    private async Task FetchMoreTracksAsync()
    {
        if (_loadingMore || !_hasMoreTracks) return;

        try
        {
            _loadingMore = true;
            StateHasChanged();

            IReadOnlyList<Track> newTracks = await SpotifyTrackService.GetPlaylistTracksAsync(PlaylistId, _offset, BatchSize, _cancellationTokenSource!.Token);

            if (newTracks.Count > 0)
            {
                _tracks.AddRange(newTracks);

                _offset += newTracks.Count;

                _hasMoreTracks = newTracks.Count == BatchSize;

                GroupTracks(_sortingControls?.CurrentSorting ?? SortingOption.Genre);
            }
            else
            {
                _hasMoreTracks = false;
            }
        }
        finally
        {
            _loadingMore = false;
            StateHasChanged();
        }
    }

    private void HandleSortingChanged(SortingOption option)
    {
        GroupTracks(option);
    }

    private void HandleViewChanged(bool isCompact)
    {
        // View state is now managed by TrackSortingControls
        StateHasChanged();
    }

    private void GroupTracks(SortingOption sortingBy)
    {
        if (sortingBy == SortingOption.Genre)
        {
            _groupedTracks = _tracks.GroupBy(t => t.Genre)
                                    .ToDictionary(g => g.Key, g => g.ToList());
        }
        else
        {
            _groupedTracks = _tracks.GroupBy(t => t.GetDecade())
                                    .OrderBy(g => g.Key)
                                    .ToDictionary(g => g.Key, g => g.ToList());
        }
    }

    public void Dispose()
    {
        _cancellationTokenSource?.Cancel();
        _cancellationTokenSource?.Dispose();
    }
}

