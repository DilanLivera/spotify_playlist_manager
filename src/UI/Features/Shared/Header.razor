@using System.Security.Claims
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthStateProvider
@rendermode InteractiveServer

<header class="w-full bg-[#1a2234] border-b border-gray-700">
    <div class="px-3 py-3 lg:px-5 lg:pl-3">
        <div class="flex items-center justify-between">
            <div class="flex items-center">
                <a href="/"
                   class="flex items-center space-x-2">
                    <svg class="w-8 h-8"
                         viewBox="0 0 1024 1024"
                         xmlns="http://www.w3.org/2000/svg">
                        <defs>
                            <!-- Background -->
                            <linearGradient id="bg" x1="0" y1="0" x2="0" y2="1">
                                <stop offset="0%" stop-color="#0f1729"/>
                                <stop offset="100%" stop-color="#0b1222"/>
                            </linearGradient>

                            <!-- Spotify green glow -->
                            <filter id="greenGlow" x="-50%" y="-50%" width="200%" height="200%">
                                <feGaussianBlur stdDeviation="16" result="blur"/>
                                <feMerge>
                                    <feMergeNode in="blur"/>
                                    <feMergeNode in="SourceGraphic"/>
                                </feMerge>
                            </filter>

                            <!-- Soft card shadow -->
                            <filter id="cardShadow" x="-20%" y="-20%" width="140%" height="140%">
                                <feDropShadow dx="0" dy="24" stdDeviation="32" flood-color="#000000" flood-opacity="0.35"/>
                            </filter>

                            <!-- Glass effect -->
                            <linearGradient id="glass" x1="0" y1="0" x2="1" y2="1">
                                <stop offset="0%" stop-color="#ffffff" stop-opacity="0.35"/>
                                <stop offset="100%" stop-color="#ffffff" stop-opacity="0.05"/>
                            </linearGradient>
                        </defs>

                        <!-- App icon background -->
                        <rect
                            x="64"
                            y="64"
                            width="896"
                            height="896"
                            rx="200"
                            fill="url(#bg)"
                        />

                        <!-- Glass panel -->
                        <rect
                            x="220"
                            y="220"
                            width="584"
                            height="584"
                            rx="72"
                            fill="url(#glass)"
                            opacity="0.85"
                            filter="url(#cardShadow)"
                        />

                        <!-- Sorting grid -->
                        <g stroke="#22C55E" stroke-width="6" opacity="0.35">
                            <line x1="340" y1="320" x2="340" y2="704"/>
                            <line x1="512" y1="320" x2="512" y2="704"/>
                            <line x1="684" y1="320" x2="684" y2="704"/>

                            <line x1="300" y1="384" x2="724" y2="384"/>
                            <line x1="300" y1="512" x2="724" y2="512"/>
                            <line x1="300" y1="640" x2="724" y2="640"/>
                        </g>

                        <!-- Music wave / note -->
                        <path
                            d="M300 560
                               C380 420, 460 700, 540 560
                               S700 420, 780 560"
                            fill="none"
                            stroke="#1DB954"
                            stroke-width="22"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            filter="url(#greenGlow)"
                        />

                        <!-- Accent nodes -->
                        <circle cx="300" cy="560" r="10" fill="#1DB954"/>
                        <circle cx="540" cy="560" r="10" fill="#1DB954"/>
                        <circle cx="780" cy="560" r="10" fill="#1DB954"/>
                    </svg>
                    <span class="text-xl font-semibold whitespace-nowrap text-green-500">
                        Spotify Playlist Manager
                    </span>
                </a>
            </div>

            <div class="flex items-center">
                @if (_isAuthenticated)
                {
                    <div class="flex items-center space-x-4">
                        <span class="text-gray-300">@_userName</span>
                        <button @onclick="SignOut"
                                class="flex items-center space-x-2 text-gray-400 hover:text-gray-200">
                            <svg class="w-6 h-6"
                                 fill="none"
                                 stroke="currentColor"
                                 viewBox="0 0 24 24"
                                 xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round"
                                      stroke-linejoin="round"
                                      stroke-width="2"
                                      d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                            </svg>
                            <span>Sign Out</span>
                        </button>
                    </div>
                }
                else
                {
                    <button @onclick="SignIn"
                            class="flex items-center space-x-2 text-gray-400 hover:text-gray-200">
                        <svg class="w-6 h-6"
                             fill="none"
                             stroke="currentColor"
                             viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round"
                                  stroke-linejoin="round"
                                  stroke-width="2"
                                  d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"/>
                        </svg>
                        <span>Sign In with Google</span>
                    </button>
                }
            </div>
        </div>
    </div>
</header>

@code {
    private bool _isAuthenticated;
    private string? _userName;

    protected override async Task OnInitializedAsync()
    {
        AuthenticationState? authState = await AuthStateProvider.GetAuthenticationStateAsync();
        ClaimsPrincipal? user = authState.User;

        if (user.Identity is null)
        {
            return;
        }

        _isAuthenticated = user.Identity.IsAuthenticated;

        if (_isAuthenticated)
        {
            _userName = user.Identity.Name;
        }
    }

    private void SignIn() => NavigationManager.NavigateTo(uri: "/signin", forceLoad: true);

    private void SignOut() => NavigationManager.NavigateTo(uri: "/signout", forceLoad: true);

}

