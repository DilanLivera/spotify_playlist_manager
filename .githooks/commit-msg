#!/bin/sh
#
# Git commit-msg hook to validate conventional commit messages
# 
# Install: git config core.hooksPath .githooks
#

commit_msg_file="$1"
commit_msg=$(cat "$commit_msg_file")

# Get the first line (subject)
subject=$(echo "$commit_msg" | head -n 1)

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
NC='\033[0m' # No Color

# Conventional commit types
types="feat|fix|build|chore|ci|docs|style|refactor|perf|test"

# Check if it's a merge commit or other special commit
if echo "$subject" | grep -qE "^(Merge|Revert|Initial commit)"; then
    exit 0
fi

# Check subject line length (max 72 characters)
subject_length=${#subject}
if [ "$subject_length" -gt 72 ]; then
    echo "${RED}ERROR: Commit message subject exceeds 72 characters (${subject_length} chars)${NC}"
    echo "Subject: $subject"
    echo ""
    echo "Please shorten your commit message subject line."
    exit 1
fi

# Check conventional commit format: type[(scope)][!]: description
if ! echo "$subject" | grep -qE "^($types)(\(.+\))?\!?: .+"; then
    echo "${RED}ERROR: Commit message does not follow Conventional Commits format${NC}"
    echo ""
    echo "Expected format: <type>[optional scope]: <description>"
    echo ""
    echo "Valid types: feat, fix, build, chore, ci, docs, style, refactor, perf, test"
    echo ""
    echo "Examples:"
    echo "  feat: add user authentication"
    echo "  fix(api): resolve null reference exception"
    echo "  docs: update README with setup instructions"
    echo "  feat!: change authentication flow (breaking change)"
    echo ""
    echo "Your message: $subject"
    exit 1
fi

# Check that subject doesn't end with a period
if echo "$subject" | grep -qE "\.$"; then
    echo "${RED}ERROR: Commit message subject should not end with a period${NC}"
    echo "Subject: $subject"
    exit 1
fi

# Check for empty description after type
if echo "$subject" | grep -qE "^($types)(\(.+\))?\!?: $"; then
    echo "${RED}ERROR: Commit message description is empty${NC}"
    echo "Subject: $subject"
    exit 1
fi

echo "${GREEN}âœ“ Commit message follows conventional commits format${NC}"
exit 0

